<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sousveillance Camera Spotting Map</title>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<style>
  html, body {
    height: 100%;
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: #fff;
  }

  #map {
    width: 100%;
    height: 100%;
  }

  .legend {
    position: absolute;
    top: 12px;
    left: 60px;
    background: rgba(255,255,255,0.95);
    border-radius: 10px;
    padding: 10px 12px;
    box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    font-size: 13px;
    line-height: 1.4;
    z-index: 1000;
  }

  .legend-row {
    display: flex;
    align-items: center;
    margin-bottom: 6px;
  }
  .legend-row:last-child {
    margin-bottom: 0;
  }

  .legend-swatch-point {
    width: 12px;
    height: 12px;
    background: #1d4ed8;
    border-radius: 50%;
    border: 2px solid #ffffff;
    box-shadow: 0 0 0 1px #1d4ed8;
    margin-right: 6px;
  }

  .legend-swatch-radius {
    width: 12px;
    height: 12px;
    background: rgba(29,78,216,0.15);
    border-radius: 50%;
    border: 1px solid #1d4ed8;
    margin-right: 6px;
  }

  /* Popup styling */
  .popup-wrapper {
    max-width: 260px;
    line-height: 1.4;
    font-size: 14px;
  }

  .popup-title {
    font-weight: 600;
    font-size: 15px;
    margin-bottom: 6px;
  }

  .popup-thumb {
    width: 100%;
    height: auto;
    border-radius: 8px;
    display: block;
    margin-bottom: 8px;
    object-fit: cover;
    background: #ddd;
  }

  .popup-line {
    background: #f5f5f5;
    border-radius: 6px;
    padding: 6px 8px;
    margin-bottom: 4px;
    word-break: break-word;
  }
</style>
</head>

<body>
<div id="map"></div>

<div class="legend">
  <!-- generic meaning -->
  <div class="legend-row">
    <div class="legend-swatch-point" style="background:#1d4ed8; box-shadow:0 0 0 1px #1d4ed8;"></div>
    <div>Camera location</div>
  </div>
  <div class="legend-row">
    <div class="legend-swatch-radius" style="background:rgba(29,78,216,0.15); border:1px solid #1d4ed8;"></div>
    <div>10 m viewing distance</div>
  </div>

  <hr style="border:none;border-top:1px solid #ddd;margin:8px 0;" />

  <!-- 5 camera types with palette -->
  <div class="legend-row">
    <div class="legend-swatch-point" style="background:#fd0457; box-shadow:0 0 0 1px #fd0457;"></div>
    <div>Bullet Camera</div>
  </div>

  <div class="legend-row">
    <div class="legend-swatch-point" style="background:#00ffcf; box-shadow:0 0 0 1px #00ffcf;"></div>
    <div>Traffic Camera</div>
  </div>

  <div class="legend-row">
    <div class="legend-swatch-point" style="background:#ff8000; box-shadow:0 0 0 1px #ff8000;"></div>
    <div>Turret Camera</div>
  </div>

  <div class="legend-row">
    <div class="legend-swatch-point" style="background:#01b6eb; box-shadow:0 0 0 1px #01b6eb;"></div>
    <div>Doorbell Camera</div>
  </div>

  <div class="legend-row">
    <div class="legend-swatch-point" style="background:#8422ff; box-shadow:0 0 0 1px #8422ff;"></div>
    <div>Dome Camera</div>
  </div>
</div>

<!-- Leaflet JS -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin="">
</script>

<script>
(function () {
  // Path to your sousveillance dataset
  var GEOJSON_URL = 'sousveillance.geojson';

  // init map
  var map = L.map('map', {
    zoomControl: true
  });

    // Dark basemap (OSM data via CARTO)
  L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
    {
      maxZoom: 20,
      attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
    }
  ).addTo(map);

  var allLatLngs = [];

  // color mapping by camera_type
  function colorForType(cameraTypeRaw) {
    var t = (cameraTypeRaw || '').toLowerCase().trim();

    if (t.includes('bullet')) return '#fd0457';
    if (t.includes('traffic')) return '#00ffcf';                // Traffic Enforcement Camera
    if (t.includes('turret')) return '#ff8000';
    if (t.includes('doorbell')) return '#01b6eb';
    if (t.includes('dome')) return '#8422ff';

    return '#666666'; // fallback
  }

  function buildPopupHTML(props) {
    var cameraType = props.camera_type || props.title || 'Camera';
    var imgURL = props.image_url || '';
    var isPointing = props.is_pointing || '';
    var purpose = props.purpose_guess || '';
    var accuracy = props.accuracy_m || props.accuracy || '';

    var html = '<div class="popup-wrapper">';

    // title
    html += '<div class="popup-title">' + cameraType + '</div>';

    // thumbnail
    if (imgURL) {
      html += '<img class="popup-thumb" src="' + imgURL + '" alt="Camera image" />';
    }

    // is it pointing at public space?
    if (isPointing) {
      html += '<div class="popup-line"><strong>Pointing at public space?</strong> ' +
              isPointing + '</div>';
    }

    // perceived purpose
    if (purpose) {
      html += '<div class="popup-line"><strong>Perceived purpose:</strong> ' +
              purpose + '</div>';
    }

    // accuracy
    if (accuracy) {
      html += '<div class="popup-line"><strong>GPS accuracy (m):</strong> ' +
              accuracy + '</div>';
    }

    html += '</div>';
    return html;
  }

  // load sousveillance.geojson
  fetch(GEOJSON_URL)
    .then(function (resp) {
      if (!resp.ok) {
        throw new Error('Failed to load ' + GEOJSON_URL + ' (' + resp.status + ')');
      }
      return resp.json();
    })
    .then(function (geojsonData) {
      var layer = L.geoJSON(geojsonData, {
        pointToLayer: function (feature, latlng) {
          var props = feature.properties || {};
          var camType = props.camera_type || props.title || '';
          var color = colorForType(camType);

          // colored marker
          var marker = L.circleMarker(latlng, {
            radius: 6,
            color: '#ffffff',
            weight: 2,
            fillColor: color,
            fillOpacity: 0.9
          });

          // popup
          marker.bindPopup(buildPopupHTML(props));

          // 10 m viewing distance halo
          var circle = L.circle(latlng, {
            radius: 10,
            color: color,
            weight: 1,
            fillColor: color,
            fillOpacity: 0.15
          });
          circle.addTo(map);

          allLatLngs.push(latlng);
          return marker;
        }
      }).addTo(map);

      // fit to data
      if (allLatLngs.length > 0) {
        var bounds = L.latLngBounds(allLatLngs);
        map.fitBounds(bounds.pad(0.2));
      } else {
        // fallback (center Amsterdam-ish)
        map.setView([52.3725, 4.9175], 16);
      }
    })
    .catch(function (err) {
      console.error(err);
      alert('Could not load sousveillance.geojson. See console for details.');
    });
})();
</script>

</body>
</html>
